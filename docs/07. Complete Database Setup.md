# üóÑÔ∏è COMPLETE DATABASE SETUP - SchoolBridge

## 1. Environment Configuration

### 1.1 Environment Variables Setup

```bash
# Create .env.local file
DATABASE_URL="postgresql://neondb_owner:npg_j68PzQBWgLpw@ep-delicate-resonance-ag0uhpiz-pooler.c-2.eu-central-1.aws.neon.tech/neondb?sslmode=require&channel_binding=require"
NEXTAUTH_SECRET="your-super-secret-nextauth-key-here"
NEXTAUTH_URL="http://localhost:3000"

# Optional for production
UPLOADTHING_SECRET="your-uploadthing-secret"
UPLOADTHING_APP_ID="your-uploadthing-app-id"
```

### 1.2 Neon Database Setup

**Database Connection Details:**
- **Host:** ep-delicate-resonance-ag0uhpiz-pooler.c-2.eu-central-1.aws.neon.tech
- **Database:** neondb
- **Region:** EU Central (Frankfurt)
- **SSL Mode:** Required with channel binding

```bash
# Install Neon CLI (optional)
npm install -g neonctl

# Connect directly via psql
psql 'postgresql://neondb_owner:npg_j68PzQBWgLpw@ep-delicate-resonance-ag0uhpiz-pooler.c-2.eu-central-1.aws.neon.tech/neondb?sslmode=require&channel_binding=require'

# Or create a new database
neonctl databases create schoolbridge
```

**Important Security Notes:**
- ‚ö†Ô∏è **Never commit credentials to version control**
- Store `DATABASE_URL` in `.env.local` (already in `.gitignore`)
- Use environment variables for all sensitive data
- Rotate credentials regularly in production

## 2. Complete Prisma Schema

### 2.1 Full Schema Definition

```prisma
// /prisma/schema.prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ========== CORE USER MANAGEMENT ==========
model User {
  id              String    @id @default(uuid())
  email           String    @unique
  phone           String?
  firstName       String
  lastName        String
  password        String?   // Null for OAuth users
  role            UserRole
  language        Language  @default(FR)
  avatar          String?
  verified        Boolean   @default(false)
  verificationCode String?
  codeExpires     DateTime?
  
  // School relationship
  school          School?   @relation(fields: [schoolId], references: [id])
  schoolId        String?
  
  // Timestamps
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  lastLoginAt     DateTime?
  
  // Relations
  accounts        Account[]
  sessions        Session[]
  
  // Application relationships
  taughtCourses   Course[]  @relation("CourseTeacher")
  createdCourses  Course[]  @relation("CourseCreator")
  validations     CourseValidation[]
  studentProfile  Student?
  parentProfile   Parent?
  teacherProfile  Teacher?
  sentMessages    Message[] @relation("MessageSender")
  receivedMessages Message[] @relation("MessageReceiver")
  gradeEntries    Grade[]
  
  @@map("users")
}

model Account {
  id                String  @id @default(uuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(uuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

// ========== SCHOOL MANAGEMENT ==========
model School {
  id        String   @id @default(uuid())
  name      String
  code      String   @unique // School identification code
  address   String?
  city      String?
  country   String   @default("Madagascar")
  timezone  String   @default("Indian/Antananarivo")
  
  // Configuration
  config    Json?    // School-specific settings
  
  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  users     User[]
  courses   Course[]
  classes   Class[]
  
  @@map("schools")
}

// ========== PROFILE MODELS ==========
model Student {
  id        String   @id @default(uuid())
  userId    String   @unique
  studentId String?  @unique // School-specific student ID
  gradeLevel String? // e.g., "CP", "CE1", "6√®me", "Terminale"
  birthDate DateTime?
  
  user      User     @relation(fields: [userId], references: [id])
  
  // Academic relationships
  enrollments ClassEnrollment[]
  grades      Grade[]
  progress    StudentProgress[]
  skillMasteries SkillMastery[]
  
  @@map("students")
}

model Teacher {
  id          String   @id @default(uuid())
  userId      String   @unique
  teacherId   String?  @unique // School-specific teacher ID
  subject     String?  // Main subject taught
  bio         String?
  
  user        User     @relation(fields: [userId], references: [id])
  
  // Teaching relationships
  taughtClasses Class[]
  
  @@map("teachers")
}

model Parent {
  id     String @id @default(uuid())
  userId String @unique
  
  user   User   @relation(fields: [userId], references: [id])
  
  // Child relationships
  children ParentStudent[]
  
  @@map("parents")
}

model ParentStudent {
  id        String   @id @default(uuid())
  parentId  String
  studentId String
  relationship String @default("parent") // parent, guardian, etc.
  isVerified Boolean @default(false)
  
  parent    Parent  @relation(fields: [parentId], references: [id])
  student   Student @relation(fields: [studentId], references: [id])
  
  @@unique([parentId, studentId])
  @@map("parent_students")
}

// ========== COURSE MANAGEMENT ==========
model Course {
  id          String        @id @default(uuid())
  title       String
  description String?
  subject     String
  gradeLevel  String?       // Target grade level
  language    Language      @default(FR)
  
  // Content configuration
  contentType ContentType   @default(INTERACTIVE)
  difficulty  Difficulty    @default(BEGINNER)
  estimatedDuration Int?    // in minutes
  
  // Status and workflow
  status      CourseStatus  @default(DRAFT)
  isPublic    Boolean       @default(false)
  requiresOnline Boolean    @default(false)
  
  // File management
  fileSize    Int?          // in bytes
  thumbnail   String?
  
  // Relationships
  creator     User          @relation("CourseCreator", fields: [creatorId], references: [id])
  creatorId   String
  teacher     User?         @relation("CourseTeacher", fields: [teacherId], references: [id])
  teacherId   String?
  school      School        @relation(fields: [schoolId], references: [id])
  schoolId    String
  
  // Validation workflow
  validations CourseValidation[]
  
  // Course content
  modules     Module[]
  assignments Assignment[]
  
  // Timestamps
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  publishedAt DateTime?
  
  @@map("courses")
}

model CourseValidation {
  id          String      @id @default(uuid())
  courseId    String
  reviewerId  String
  status      ValidationStatus @default(PENDING)
  feedback    String?
  suggestions Json?       // Structured suggestions
  reviewedAt  DateTime?
  
  course      Course      @relation(fields: [courseId], references: [id])
  reviewer    User        @relation(fields: [reviewerId], references: [id])
  
  createdAt   DateTime    @default(now())
  
  @@unique([courseId, reviewerId])
  @@map("course_validations")
}

// ========== COURSE CONTENT ==========
model Module {
  id          String   @id @default(uuid())
  title       String
  description String?
  order       Int      // Module order in course
  courseId    String
  
  course      Course   @relation(fields: [courseId], references: [id])
  lessons     Lesson[]
  
  @@map("modules")
}

model Lesson {
  id          String        @id @default(uuid())
  title       String
  content     Json?         // Structured lesson content
  order       Int           // Lesson order in module
  moduleId    String
  
  // Timing controls for content
  timingConfig Json?        // { appearsAfter: 30, disappearsAfter: 60 }
  
  // Media references
  videoUrl    String?
  pdfUrl      String?
  attachments Json?         // Array of attachment URLs
  
  module      Module        @relation(fields: [moduleId], references: [id])
  progress    StudentProgress[]
  
  @@map("lessons")
}

// ========== CLASS & ENROLLMENT ==========
model Class {
  id        String   @id @default(uuid())
  name      String
  gradeLevel String
  subject   String?
  schoolId  String
  teacherId String?
  
  school    School   @relation(fields: [schoolId], references: [id])
  teacher   Teacher? @relation(fields: [teacherId], references: [id])
  
  enrollments ClassEnrollment[]
  assignments Assignment[]
  
  @@map("classes")
}

model ClassEnrollment {
  id        String   @id @default(uuid())
  classId   String
  studentId String
  enrolledAt DateTime @default(now())
  
  class     Class    @relation(fields: [classId], references: [id])
  student   Student  @relation(fields: [studentId], references: [id])
  
  @@unique([classId, studentId])
  @@map("class_enrollments")
}

// ========== ASSIGNMENTS & GRADES ==========
model Assignment {
  id          String    @id @default(uuid())
  title       String
  description String?
  dueDate     DateTime?
  maxPoints   Int       @default(100)
  courseId    String?
  classId     String?
  
  course      Course?   @relation(fields: [courseId], references: [id])
  class       Class?    @relation(fields: [classId], references: [id])
  grades      Grade[]
  
  @@map("assignments")
}

model Grade {
  id           String   @id @default(uuid())
  studentId    String
  assignmentId String
  teacherId    String   // Who graded it
  score        Decimal  // Actual score
  maxScore     Decimal  // Maximum possible score
  feedback     String?
  gradedAt     DateTime @default(now())
  
  student      Student  @relation(fields: [studentId], references: [id])
  assignment   Assignment @relation(fields: [assignmentId], references: [id])
  teacher      User     @relation(fields: [teacherId], references: [id])
  
  @@unique([studentId, assignmentId])
  @@map("grades")
}

// ========== SKILLS & PROGRESS TRACKING ==========
model Skill {
  id          String   @id @default(uuid())
  name        String
  description String?
  subject     String
  gradeLevel  String?
  parentSkillId String? // For skill hierarchy
  
  parentSkill Skill?   @relation("SkillHierarchy", fields: [parentSkillId], references: [id])
  childSkills Skill[]  @relation("SkillHierarchy")
  masteries   SkillMastery[]
  
  @@map("skills")
}

model SkillMastery {
  id          String   @id @default(uuid())
  studentId   String
  skillId     String
  masteryLevel Int     @default(0) // 0-100 percentage
  badgesEarned Json?   // Array of badge IDs
  
  student     Student  @relation(fields: [studentId], references: [id])
  skill       Skill    @relation(fields: [skillId], references: [id])
  
  updatedAt   DateTime @updatedAt
  
  @@unique([studentId, skillId])
  @@map("skill_masteries")
}

model Badge {
  id          String   @id @default(uuid())
  name        String
  description String
  icon        String   // URL to badge icon
  criteria    Json     // Achievement criteria
  skillId     String?
  
  skill       Skill?   @relation(fields: [skillId], references: [id])
  
  @@map("badges")
}

// ========== PARENT-TEACHER COMMUNICATION ==========
model ParentInstruction {
  id           String   @id @default(uuid())
  teacherId    String
  studentId    String
  title        String
  instruction  String
  isUrgent     Boolean  @default(false)
  isCompleted  Boolean  @default(false)
  
  // Visibility control
  visibleTo    Json     // ["parent", "teacher"] - explicitly define who can see
  
  teacher      User     @relation(fields: [teacherId], references: [id])
  student      Student  @relation(fields: [studentId], references: [id])
  completions  ParentInstructionCompletion[]
  
  createdAt    DateTime @default(now())
  expiresAt    DateTime?
  
  @@map("parent_instructions")
}

model ParentInstructionCompletion {
  id             String   @id @default(uuid())
  instructionId  String
  parentId       String
  completedAt    DateTime @default(now())
  notes          String?
  
  instruction    ParentInstruction @relation(fields: [instructionId], references: [id])
  parent         User     @relation(fields: [parentId], references: [id])
  
  @@unique([instructionId, parentId])
  @@map("parent_instruction_completions")
}

// ========== PROGRESS TRACKING ==========
model StudentProgress {
  id          String   @id @default(uuid())
  studentId   String
  lessonId    String
  completed   Boolean  @default(false)
  timeSpent   Int      @default(0) // in seconds
  lastActivityAt DateTime?
  
  student     Student  @relation(fields: [studentId], references: [id])
  lesson      Lesson   @relation(fields: [lessonId], references: [id])
  
  @@unique([studentId, lessonId])
  @@map("student_progress")
}

// ========== OFFLINE SYNC ==========
model OfflineSync {
  id          String   @id @default(uuid())
  userId      String
  deviceId    String
  lastSyncAt  DateTime
  pendingChanges Json? // Changes waiting to be synced

  user        User     @relation(fields: [userId], references: [id])

  @@unique([userId, deviceId])
  @@map("offline_syncs")
}

// ========== AUDIT & MONITORING ==========
model AuditLog {
  id          String   @id @default(uuid())
  userId      String?
  action      String   // e.g., "CREATE_COURSE", "UPDATE_GRADE", "DELETE_USER"
  entityType  String   // e.g., "Course", "Grade", "User"
  entityId    String
  oldValue    Json?    // Previous state
  newValue    Json?    // New state
  ipAddress   String?
  userAgent   String?
  metadata    Json?    // Additional context
  createdAt   DateTime @default(now())

  user        User?    @relation(fields: [userId], references: [id])

  @@index([userId, createdAt])
  @@index([entityType, entityId])
  @@index([action, createdAt])
  @@map("audit_logs")
}

model Notification {
  id          String           @id @default(uuid())
  userId      String
  type        NotificationType
  title       String
  message     String
  data        Json?            // Additional notification data
  read        Boolean          @default(false)
  readAt      DateTime?
  actionUrl   String?          // Link to related resource
  priority    NotificationPriority @default(NORMAL)
  createdAt   DateTime         @default(now())
  expiresAt   DateTime?

  user        User             @relation(fields: [userId], references: [id])

  @@index([userId, read, createdAt])
  @@index([type, createdAt])
  @@map("notifications")
}

model ContentVersion {
  id          String   @id @default(uuid())
  courseId    String
  version     Int
  content     Json     // Full course content snapshot
  changes     String?  // Description of changes
  createdBy   String
  createdAt   DateTime @default(now())

  course      Course   @relation(fields: [courseId], references: [id])
  creator     User     @relation(fields: [createdBy], references: [id])

  @@unique([courseId, version])
  @@index([courseId, createdAt])
  @@map("content_versions")
}

// ========== ENUMS ==========
enum UserRole {
  STUDENT
  TEACHER
  PARENT
  ADMIN
  RESPONSABLE_PEDAGOGIQUE
}

enum Language {
  FR
  EN
  MG
  ES
}

enum CourseStatus {
  DRAFT
  UNDER_REVIEW
  APPROVED
  PUBLISHED
  ARCHIVED
}

enum ValidationStatus {
  PENDING
  APPROVED
  CHANGES_REQUESTED
  REJECTED
}

enum ContentType {
  TEXT
  VIDEO
  INTERACTIVE
  PDF
  QUIZ
}

enum Difficulty {
  BEGINNER
  INTERMEDIATE
  ADVANCED
}

enum NotificationType {
  COURSE_ASSIGNED
  GRADE_POSTED
  PARENT_INSTRUCTION
  COURSE_VALIDATED
  COURSE_REJECTED
  ASSIGNMENT_DUE
  SYSTEM_ALERT
  MESSAGE_RECEIVED
}

enum NotificationPriority {
  LOW
  NORMAL
  HIGH
  URGENT
}
```

## 3. Database Client Setup

### 3.1 Database Client Configuration

```typescript
// /src/lib/db.ts
import { PrismaClient } from '@prisma/client'

const globalForPrisma = globalThis as unknown as {
  prisma: PrismaClient | undefined
}

export const prisma = globalForPrisma.prisma ?? new PrismaClient()

if (process.env.NODE_ENV !== 'production') {
  globalForPrisma.prisma = prisma
}
```

### 3.2 Database Seed Data

```typescript
// /prisma/seed.ts
import { PrismaClient } from '@prisma/client'
import { hash } from 'bcryptjs'

const prisma = new PrismaClient()

async function main() {
  console.log('Seeding database...')

  // Create a school
  const school = await prisma.school.upsert({
    where: { code: 'SCH001' },
    update: {},
    create: {
      name: 'Lyc√©e Fran√ßais de Madagascar',
      code: 'SCH001',
      address: 'Antananarivo',
      country: 'Madagascar',
    },
  })

  // Create admin user
  const adminPassword = await hash('admin123', 12)
  const admin = await prisma.user.upsert({
    where: { email: 'admin@school.mg' },
    update: {},
    create: {
      email: 'admin@school.mg',
      firstName: 'Admin',
      lastName: 'System',
      password: adminPassword,
      role: 'ADMIN',
      verified: true,
      schoolId: school.id,
    },
  })

  // Create sample teacher
  const teacherPassword = await hash('teacher123', 12)
  const teacher = await prisma.user.upsert({
    where: { email: 'teacher@school.mg' },
    update: {},
    create: {
      email: 'teacher@school.mg',
      firstName: 'Marie',
      lastName: 'Rakoto',
      password: teacherPassword,
      role: 'TEACHER',
      verified: true,
      schoolId: school.id,
      teacherProfile: {
        create: {
          teacherId: 'T001',
          subject: 'Mathematics',
        },
      },
    },
  })

  // Create sample skills
  const mathSkills = await prisma.skill.createMany({
    data: [
      {
        name: 'Addition basique',
        description: 'Ma√Ætriser les additions simples',
        subject: 'Mathematics',
        gradeLevel: 'CP',
      },
      {
        name: 'Soustraction',
        description: 'Ma√Ætriser les soustractions',
        subject: 'Mathematics', 
        gradeLevel: 'CP',
      },
    ],
  })

  console.log('Seeding completed!')
}

main()
  .catch((e) => {
    console.error(e)
    process.exit(1)
  })
  .finally(async () => {
    await prisma.$disconnect()
  })
```

## 4. Database Commands

### 4.1 Essential Prisma Commands

```bash
# Initialize Prisma
npx prisma generate

# Push schema to database
npx prisma db push

# Run seed data
npx prisma db seed

# Open Prisma Studio (GUI)
npx prisma studio

# Create migration (if using migrate)
npx prisma migrate dev --name init

# Reset database (development)
npx prisma db reset

# Check database status
npx prisma db status
```

### 4.2 Package.json Scripts

```json
{
  "scripts": {
    "db:generate": "prisma generate",
    "db:push": "prisma db push",
    "db:seed": "prisma db seed",
    "db:studio": "prisma studio",
    "db:reset": "prisma db reset",
    "db:migrate": "prisma migrate dev"
  }
}
```

## 5. Database Optimization

### 5.1 Indexes for Performance

```prisma
// Add to your schema for better performance
@@index([schoolId, status])
@@index([teacherId, createdAt])
@@index([studentId, completed])
@@index([email, verified])
```

### 5.2 Connection Pooling with Neon

```typescript
// For production with Neon
const prisma = new PrismaClient({
  datasources: {
    db: {
      url: process.env.DATABASE_URL + '&pgbouncer=true&connection_limit=10',
    },
  },
})
```

## 6. Verification Steps

### 6.1 Test Database Connection

```typescript
// /src/scripts/test-db.ts
import { prisma } from '@/lib/db'

async function testConnection() {
  try {
    await prisma.$connect()
    console.log('‚úÖ Database connected successfully')
    
    const userCount = await prisma.user.count()
    console.log(`üìä Total users: ${userCount}`)
    
  } catch (error) {
    console.error('‚ùå Database connection failed:', error)
  } finally {
    await prisma.$disconnect()
  }
}

testConnection()
```

Run this with:

```bash
npx tsx src/scripts/test-db.ts
```

---

üöÄ Next Steps:

1. Run the database setup:
   ```bash
   npm run db:generate
   npm run db:push  
   npm run db:seed
   ```
2. Verify everything works:
   ```bash
   npm run db:studio  # Check data in GUI
   ```
3. Start implementing authentication using the User model
